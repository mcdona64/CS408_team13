cah.GameList=function(){this.element_=$("#game_list")[0];this.games_={};this.filter_=null;$("#create_game").click(cah.bind(this,this.createGameClick_));$("#refresh_games").click(cah.bind(this,this.refreshGamesClick_));$("#filter_games").keyup(cah.bind(this,this.filterGamesChange_));};$(document).ready(function(){cah.GameList.instance=new cah.GameList();});cah.GameList.prototype.show=function(){$(this.element_).show();$("#create_game").show();$("#refresh_games").show();$("#filter_games").show();};cah.GameList.prototype.hide=function(){$(this.element_).hide();$("#create_game").hide();$("#refresh_games").hide();$("#filter_games").hide();};cah.GameList.prototype.update=function(){if($(this.element_).is(":visible")&&cah.windowActive){cah.Ajax.build(cah.$.AjaxOperation.GAME_LIST).run();cah.missedGameListRefresh=false;}else{cah.missedGameListRefresh=true;}};cah.GameList.prototype.processUpdate=function(gameData){for(var key in this.games_){this.games_[key].dispose();}
this.games_={};var passworded=new Array();var notPassworded=new Array();for(var key in gameData[cah.$.AjaxResponse.GAMES]){var game=gameData[cah.$.AjaxResponse.GAMES][key];if(game[cah.$.GameInfo.HAS_PASSWORD]){passworded.push(game);}else{notPassworded.push(game);}}
var games=notPassworded.concat(passworded);var bannedSets=cah.Preferences.getBannedCardSetIds();var requiredSets=cah.Preferences.getRequiredCardSetIds();for(var i=0;i<games.length;i++){var game=games[i];var gameOptions=game[cah.$.GameInfo.GAME_OPTIONS];var hasBanned=false;$(bannedSets).each(function(index,value){if(-1!==$.inArray(value,gameOptions[cah.$.GameOptionData.CARD_SETS])){hasBanned=true;return false;}});var missingRequired=false;$(requiredSets).each(function(index,value){if(-1===$.inArray(value,gameOptions[cah.$.GameOptionData.CARD_SETS])){missingRequired=true;return false;}});if(hasBanned||missingRequired){continue;}
var lobby=new cah.GameListLobby(this.element_,game);this.games_[game[cah.$.GameInfo.ID]]=lobby;}
if(gameData[cah.$.AjaxResponse.GAMES].length<gameData[cah.$.AjaxResponse.MAX_GAMES]){$("#create_game").removeAttr("disabled");}else{$("#create_game").attr("disabled","disabled");}
this.applyFilter();};cah.GameList.prototype.joinGame=function(id){var game=this.games_[Number(id)];if(game){game.join();}else{throw'Game '+ id+' does not exist.';}};cah.GameList.prototype.setFilter=function(filterRegExp){try{this.filter_=new RegExp(filterRegExp||'.','i');}catch(err){}};cah.GameList.prototype.applyFilter=function(filterRegExp){if(filterRegExp||filterRegExp===''){this.setFilter(filterRegExp);}
var filter=this.filter_,gamelist=$('.gamelist_lobby').show();if(filter&&filter.test){gamelist.filter(function(i){return!filter.test($(this).text());}).hide();}};cah.GameList.prototype.createGameClick_=function(){cah.Ajax.build(cah.$.AjaxOperation.CREATE_GAME).run();};cah.GameList.prototype.refreshGamesClick_=function(){this.update();};cah.GameList.prototype.filterGamesChange_=function(){this.applyFilter($('#filter_games').val());};cah.GameListLobby=function(parentElem,data){this.id_=data[cah.$.GameInfo.ID];this.parentElem_=parentElem;this.element_=$("#gamelist_lobby_template").clone()[0];this.data_=data;var options=data[cah.$.GameInfo.GAME_OPTIONS];this.element_.id="gamelist_lobby_"+ this.id_;$(parentElem).append(this.element_);$(this.element_).removeClass("hide");$(".gamelist_lobby_id",this.element_).text(this.id_);$(".gamelist_lobby_host",this.element_).text(data[cah.$.GameInfo.HOST]);$(".gamelist_lobby_players",this.element_).text(data[cah.$.GameInfo.PLAYERS].join(", "));$(".gamelist_lobby_spectators",this.element_).text(data[cah.$.GameInfo.SPECTATORS].join(", "));var statusMessage=cah.$.GameState_msg[data[cah.$.GameInfo.STATE]];$(".gamelist_lobby_status",this.element_).text(statusMessage);$(".gamelist_lobby_join",this.element_).click(cah.bind(this,this.joinClick));$(".gamelist_lobby_spectate",this.element_).click(cah.bind(this,this.spectateClick));$(".gamelist_lobby_player_count",this.element_).text(data[cah.$.GameInfo.PLAYERS].length);$(".gamelist_lobby_max_players",this.element_).text(options[cah.$.GameOptionData.PLAYER_LIMIT]);$(".gamelist_lobby_spectator_count",this.element_).text(data[cah.$.GameInfo.SPECTATORS].length);$(".gamelist_lobby_max_spectators",this.element_).text(options[cah.$.GameOptionData.SPECTATOR_LIMIT]);$(".gamelist_lobby_goal",this.element_).text(options[cah.$.GameOptionData.SCORE_LIMIT]);var cardSets=options[cah.$.GameOptionData.CARD_SETS];var cardSetNames=[];cardSets.sort();for(var key in cardSets){var cardSetId=cardSets[key];cardSetNames.push(cah.CardSet.list[cardSetId].getName());}
$(".gamelist_lobby_cardset",this.element_).html(cardSetNames.join(', '));if(data[cah.$.GameInfo.HAS_PASSWORD]){$(".gamelist_lobby_join",this.element_).val("Join\n(Passworded)");}
$(this.element_).attr("aria-label",data[cah.$.GameInfo.HOST]+"'s game, with "+ data[cah.$.GameInfo.PLAYERS].length+" of "
+ options[cah.$.GameOptionData.PLAYER_LIMIT]+" players, and "
+ data[cah.$.GameInfo.SPECTATORS].length+" of "
+ options[cah.$.GameOptionData.SPECTATOR_LIMIT]+"spectators. "+ statusMessage
+". Goal is "+ options[cah.$.GameOptionData.SCORE_LIMIT]+" Awesome Points. Using "
+ cardSetNames.length+" card set"+(cardSetNames.length==1?"":"s")+". "
+(data[cah.$.GameInfo.HAS_PASSWORD]?"Has":"Does not have")+" a password.");};cah.GameListLobby.prototype.joinClick=function(){var password="";if(this.data_[cah.$.GameInfo.HAS_PASSWORD]){password=prompt("Enter the game's password.");if(password==null){password="";}}
cah.Ajax.build(cah.$.AjaxOperation.JOIN_GAME).withGameId(this.id_).withPassword(password).run();};cah.GameListLobby.prototype.join=function(){$('.gamelist_lobby_join',this.element_).click();};cah.GameListLobby.prototype.spectateClick=function(){var password="";if(this.data_[cah.$.GameInfo.HAS_PASSWORD]){password=prompt("Enter the game's password.");if(password==null){password="";}}
cah.Ajax.build(cah.$.AjaxOperation.SPECTATE_GAME).withGameId(this.id_).withPassword(password).run();};cah.GameListLobby.prototype.dispose=function(){this.parentElem_.removeChild(this.element_);$(".gamelist_lobby_join",this.element_).unbind();$(".gamelist_lobby_spectate",this.element_).unbind();};